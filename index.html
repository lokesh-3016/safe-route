<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SafeRoute ‚Äì Smart Shelter Finder (Demo)</title>

  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root{
      --bg:#0b1220;
      --card:#111b2e;
      --muted:#9fb0d0;
      --text:#e9f1ff;
      --border: rgba(255,255,255,0.12);
      --good:#2ecc71;
      --warn:#f1c40f;
      --bad:#e74c3c;
      --accent:#4aa3ff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--text)}
    a{color:var(--accent)}
    .container{max-width:1200px;margin:0 auto;padding:16px}
    .row{display:flex; gap:16px; flex-wrap:wrap}
    .card{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px}
    .card h2,.card h3{margin:0 0 10px 0}
    .muted{color:var(--muted)}
    .btn{
      border:1px solid var(--border);
      background:#0f1a30;
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
    }
    .btn:hover{border-color:rgba(255,255,255,0.25)}
    .btn.primary{background:var(--accent); border-color:transparent; color:#001226}
    .btn.danger{background:var(--bad); border-color:transparent}
    .btn.good{background:var(--good); border-color:transparent; color:#04160c}
    .btn.small{padding:7px 10px;border-radius:10px;font-size:13px}
    input, select, textarea{
      width:100%;
      background:#0b1426;
      border:1px solid var(--border);
      color:var(--text);
      padding:10px 10px;
      border-radius:12px;
      outline:none;
    }
    textarea{min-height:90px; resize:vertical}
    label{display:block; font-size:13px; color:var(--muted); margin:10px 0 6px}
    .grid{display:grid; gap:12px}
    .grid.two{grid-template-columns:repeat(2, minmax(0, 1fr))}
    .grid.three{grid-template-columns:repeat(3, minmax(0, 1fr))}
    @media (max-width:900px){
      .grid.two,.grid.three{grid-template-columns:1fr}
    }
    .topbar{
      position:sticky; top:0; z-index:50;
      background:rgba(11,18,32,0.9); backdrop-filter: blur(10px);
      border-bottom:1px solid var(--border);
    }
    .topbar .inner{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 16px; max-width:1200px; margin:0 auto}
    .pill{display:inline-flex; align-items:center; gap:8px; border:1px solid var(--border); padding:6px 10px; border-radius:999px; font-size:13px; color:var(--muted)}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.g{background:var(--good)} .dot.y{background:var(--warn)} .dot.r{background:var(--bad)}
    .hidden{display:none !important}
    #map{height:520px; border-radius:14px; overflow:hidden; border:1px solid var(--border)}
    .statusTag{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-weight:700; font-size:12px}
    .tagG{background:rgba(46,204,113,0.15); border:1px solid rgba(46,204,113,0.35)}
    .tagY{background:rgba(241,196,15,0.15); border:1px solid rgba(241,196,15,0.35)}
    .tagR{background:rgba(231,76,60,0.15); border:1px solid rgba(231,76,60,0.35)}
    .table{width:100%; border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid var(--border); padding:10px; text-align:left; vertical-align:top}
    .table th{font-size:13px; color:var(--muted); font-weight:700}
    .list{display:flex; flex-direction:column; gap:10px}
    .item{border:1px solid var(--border); border-radius:14px; padding:12px; background:#0b1426}
    .itemHead{display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace}
    .sosBanner{border:1px solid rgba(231,76,60,0.35); background:rgba(231,76,60,0.12); padding:10px; border-radius:14px}
    .reply{margin-top:8px; padding:10px; border-radius:12px; border:1px solid var(--border); background:#0a1222}
  </style>
</head>
<body>

  <div class="topbar hidden" id="topbar">
    <div class="inner">
      <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
        <div style="font-weight:900; letter-spacing:0.4px;">SafeRoute</div>
        <div class="pill" id="whoamiPill">‚Äî</div>
        <div class="pill" id="netPill">Checking network‚Ä¶</div>
      </div>
      <button class="btn small" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="container">

    
    <section id="screenLogin" class="card">
      <h2>SafeRoute ‚Äì Demo Login</h2>
      <p class="muted">Choose a role and login. (Prototype: uses localStorage, no backend needed)</p>

      <div class="grid two">
        <div>
          <label>Role</label>
          <select id="loginRole">
            <option value="admin">Admin</option>
            <option value="manager">Shelter Manager</option>
            <option value="user">User</option>
          </select>
        </div>
        <div>
          <label>Username</label>
          <input id="loginUser" placeholder="e.g. admin / mgr1 / user1" />
        </div>
      </div>

      <label>Password</label>
      <input id="loginPass" type="password" placeholder="For demo: admin123 / manager123 / user123"/>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px">
        <button class="btn primary" onclick="handleLogin()">Login</button>
        <button class="btn" onclick="resetDemo()">Reset Demo Data</button>
      </div>

      <div class="card" style="margin-top:14px">
        <h3>Demo Credentials</h3>
        <div class="grid three">
          <div class="item">
            <div class="mono"><b>Admin</b></div>
            <div class="muted mono">username: admin</div>
            <div class="muted mono">password: admin123</div>
          </div>
          <div class="item">
            <div class="mono"><b>Manager</b></div>
            <div class="muted mono">username: mgr1</div>
            <div class="muted mono">password: manager123</div>
          </div>
          <div class="item">
            <div class="mono"><b>User</b></div>
            <div class="muted mono">username: user1</div>
            <div class="muted mono">password: user123</div>
          </div>
        </div>
        <p class="muted" style="margin-top:10px">
          Tip: Login as Admin ‚Üí update capacity to make a shelter Full ‚Üí switch to User to see colors change.
        </p>
      </div>
    </section>

    
    <section id="screenAdmin" class="hidden">
      <div class="row">
        <div class="card" style="flex:1; min-width:320px">
          <h2>Admin Dashboard</h2>
          <p class="muted">Manage shelters, managers, messages, and SOS alerts.</p>

          <div class="grid two">
            <div class="item">
              <div class="muted">Total Shelters</div>
              <div style="font-size:28px; font-weight:900" id="adminTotalShelters">0</div>
            </div>
            <div class="item">
              <div class="muted">Open SOS Alerts</div>
              <div style="font-size:28px; font-weight:900" id="adminOpenSOS">0</div>
            </div>
          </div>

          <div style="margin-top:12px" class="sosBanner">
            <b>Quick Note:</b> Admin receives capacity updates from Shelter Managers, and can reply to User messages & SOS.
          </div>
        </div>

        <div class="card" style="flex:1.6; min-width:340px">
          <h3>Live Shelter Map (Admin View)</h3>
          <div id="mapAdmin" style="height:360px;border-radius:14px;border:1px solid var(--border)"></div>
          <p class="muted" style="margin:10px 0 0 0">
            Marker colors: <span class="pill"><span class="dot g"></span>Green</span>
            <span class="pill"><span class="dot y"></span>Yellow</span>
            <span class="pill"><span class="dot r"></span>Red</span>
          </p>
        </div>
      </div>

      <div class="row" style="margin-top:16px">
        <div class="card" style="flex:1.2; min-width:340px">
          <h3>Shelter Managers</h3>
          <div id="adminManagersList" class="list"></div>
        </div>

        <div class="card" style="flex:2; min-width:360px">
          <h3>Shelters (Edit Capacity / Facilities)</h3>
          <div id="adminSheltersList" class="list"></div>
        </div>
      </div>

      <div class="row" style="margin-top:16px">
        <div class="card" style="flex:1.5; min-width:360px">
          <h3>User Messages Inbox</h3>
          <div id="adminMessagesList" class="list"></div>
        </div>

        <div class="card" style="flex:1.5; min-width:360px">
          <h3>SOS Alerts</h3>
          <div id="adminSOSList" class="list"></div>
        </div>
      </div>
    </section>

    
    <section id="screenManager" class="hidden">
      <div class="row">
        <div class="card" style="flex:1; min-width:340px">
          <h2>Shelter Manager Dashboard</h2>
          <p class="muted">Update only your shelter‚Äôs occupancy and resources. Admin sees updates instantly.</p>

          <div class="item">
            <div class="muted">Assigned Shelter</div>
            <div style="font-size:18px; font-weight:900" id="mgrShelterName">‚Äî</div>
            <div class="muted" id="mgrShelterMeta">‚Äî</div>
          </div>

          <div class="grid two" style="margin-top:12px">
            <div>
              <label>Occupied (people currently inside)</label>
              <input id="mgrOccupied" type="number" min="0" />
            </div>
            <div>
              <label>Shelter Open?</label>
              <select id="mgrOpen">
                <option value="true">Open</option>
                <option value="false">Closed</option>
              </select>
            </div>
          </div>

          <div class="grid three" style="margin-top:12px">
            <div>
              <label>Food</label>
              <select id="mgrFood">
                <option value="available">Available</option>
                <option value="low">Low</option>
                <option value="out">Out</option>
              </select>
            </div>
            <div>
              <label>Water</label>
              <select id="mgrWater">
                <option value="available">Available</option>
                <option value="low">Low</option>
                <option value="out">Out</option>
              </select>
            </div>
            <div>
              <label>Medical</label>
              <select id="mgrMedical">
                <option value="available">Available</option>
                <option value="limited">Limited</option>
                <option value="none">Not available</option>
              </select>
            </div>
          </div>

          <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap">
            <button class="btn primary" onclick="managerSubmitUpdate()">Send Update to Admin</button>
            <button class="btn" onclick="renderAll()">Refresh</button>
          </div>

          <p class="muted" style="margin-top:10px">
            Status color is auto-calculated using capacity buffer rules.
          </p>
        </div>

        <div class="card" style="flex:1.2; min-width:360px">
          <h3>Map View (Your Shelter)</h3>
          <div id="mapManager" style="height:520px;border-radius:14px;border:1px solid var(--border)"></div>
        </div>
      </div>
    </section>


    <section id="screenUser" class="hidden">
      <div class="row">
        <div class="card" style="flex:2; min-width:360px">
          <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap">
            <div>
              <h2>User Panel</h2>
              <p class="muted">Find shelters nearby, message admin, or send SOS.</p>
            </div>
            <button class="btn danger" onclick="openSOSModal()">üö® SOS</button>
          </div>

          <div id="map"></div>

          <div class="row" style="margin-top:12px">
            <div class="card" style="flex:1; min-width:280px">
              <h3>Recommended Shelter ‚≠ê</h3>
              <div id="recommendedBox" class="item"></div>
              <p class="muted" style="margin-top:10px">
                Offline mode uses conservative recommendation and shows last-updated timestamps.
              </p>
            </div>
            <div class="card" style="flex:1.2; min-width:300px">
              <h3>Shelter Details</h3>
              <div id="shelterDetails" class="item muted">Click a shelter marker to view details.</div>
              <div style="margin-top:10px">
                <button class="btn primary small" onclick="openMessageModal()">Message Admin</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card" style="flex:1; min-width:320px">
          <h3>Messages</h3>
          <p class="muted">Your messages to Admin + Admin replies appear here.</p>
          <div id="userMsgThread" class="list"></div>
        </div>
      </div>
    </section>

    
    <section id="modalMsg" class="hidden card" style="position:fixed; inset:0; margin:auto; max-width:720px; height:max-content; z-index:999; box-shadow:0 10px 40px rgba(0,0,0,0.5)">
      <h3>Send Message to Admin</h3>
      <p class="muted">Optional: include shelter name and number of people coming.</p>
      <label>Message</label>
      <textarea id="msgText" placeholder="Example: We are 4 people, need medical support. Which shelter is safe?"></textarea>
      <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:12px">
        <button class="btn" onclick="closeMessageModal()">Cancel</button>
        <button class="btn primary" onclick="sendMessageToAdmin()">Send</button>
      </div>
    </section>

    
    <section id="modalSOS" class="hidden card" style="position:fixed; inset:0; margin:auto; max-width:720px; height:max-content; z-index:999; box-shadow:0 10px 40px rgba(0,0,0,0.5)">
      <h3>üö® Send SOS</h3>
      <p class="muted">This creates an SOS ticket for Admin (demo). Your location is attached.</p>
      <label>Reason</label>
      <select id="sosReason">
        <option value="Medical emergency">Medical emergency</option>
        <option value="Rescue needed / trapped">Rescue needed / trapped</option>
        <option value="No shelter nearby">No shelter nearby</option>
        <option value="Other">Other</option>
      </select>
      <label>Message</label>
      <textarea id="sosMsg" placeholder="Example: My family is stuck near waterlogged area, need help."></textarea>

      <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:12px">
        <button class="btn" onclick="closeSOSModal()">Cancel</button>
        <button class="btn danger" onclick="sendSOS()">Send SOS</button>
      </div>
    </section>

  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    
    const LS_KEYS = {
      SHELTERS: "saferoute_shelters_v1",
      MANAGERS: "saferoute_managers_v1",
      MESSAGES: "saferoute_messages_v1",
      SOS: "saferoute_sos_v1",
      SESSION: "saferoute_session_v1"
    };

    const DEMO = {
      
      shelters: [
        {
          id: "S1",
          name: "Relief Camp ‚Äì Egmore School",
          lat: 13.0737, lng: 80.2609,
          totalCapacity: 30,
          occupied: 18,
          open: true,
          food: "available", water: "available", medical: "limited",
          managerId: "M1",
          lastUpdated: nowISO()
        },
        {
          id: "S2",
          name: "Community Hall ‚Äì T. Nagar",
          lat: 13.0418, lng: 80.2337,
          totalCapacity: 50,
          occupied: 45,
          open: true,
          food: "low", water: "available", medical: "available",
          managerId: "M2",
          lastUpdated: nowISO()
        },
        {
          id: "S3",
          name: "Govt Shelter ‚Äì Marina Zone",
          lat: 13.0483, lng: 80.2824,
          totalCapacity: 40,
          occupied: 40,
          open: true,
          food: "available", water: "low", medical: "none",
          managerId: "M3",
          lastUpdated: nowISO()
        },
        {
          id: "S4",
          name: "Temple Shelter ‚Äì Kilpauk",
          lat: 13.0795, lng: 80.2430,
          totalCapacity: 25,
          occupied: 10,
          open: true,
          food: "available", water: "available", medical: "available",
          managerId: "M4",
          lastUpdated: nowISO()
        },
      ],
      managers: [
        { id: "M1", username: "mgr1", password: "manager123", name: "Shelter Manager 1", shelterId: "S1", phone: "+91-90000-00001" },
        { id: "M2", username: "mgr2", password: "manager123", name: "Shelter Manager 2", shelterId: "S2", phone: "+91-90000-00002" },
        { id: "M3", username: "mgr3", password: "manager123", name: "Shelter Manager 3", shelterId: "S3", phone: "+91-90000-00003" },
        { id: "M4", username: "mgr4", password: "manager123", name: "Shelter Manager 4", shelterId: "S4", phone: "+91-90000-00004" },
      ]
    };

    function loadOrInit() {
      if (!localStorage.getItem(LS_KEYS.SHELTERS)) {
        localStorage.setItem(LS_KEYS.SHELTERS, JSON.stringify(DEMO.shelters));
      }
      if (!localStorage.getItem(LS_KEYS.MANAGERS)) {
        localStorage.setItem(LS_KEYS.MANAGERS, JSON.stringify(DEMO.managers));
      }
      if (!localStorage.getItem(LS_KEYS.MESSAGES)) {
        localStorage.setItem(LS_KEYS.MESSAGES, JSON.stringify([]));
      }
      if (!localStorage.getItem(LS_KEYS.SOS)) {
        localStorage.setItem(LS_KEYS.SOS, JSON.stringify([]));
      }
    }

    function resetDemo() {
      localStorage.setItem(LS_KEYS.SHELTERS, JSON.stringify(DEMO.shelters));
      localStorage.setItem(LS_KEYS.MANAGERS, JSON.stringify(DEMO.managers));
      localStorage.setItem(LS_KEYS.MESSAGES, JSON.stringify([]));
      localStorage.setItem(LS_KEYS.SOS, JSON.stringify([]));
      alert("Demo data reset ‚úÖ");
      renderAll();
    }

    function getShelters(){ return JSON.parse(localStorage.getItem(LS_KEYS.SHELTERS) || "[]"); }
    function setShelters(arr){ localStorage.setItem(LS_KEYS.SHELTERS, JSON.stringify(arr)); }
    function getManagers(){ return JSON.parse(localStorage.getItem(LS_KEYS.MANAGERS) || "[]"); }
    function getMessages(){ return JSON.parse(localStorage.getItem(LS_KEYS.MESSAGES) || "[]"); }
    function setMessages(arr){ localStorage.setItem(LS_KEYS.MESSAGES, JSON.stringify(arr)); }
    function getSOS(){ return JSON.parse(localStorage.getItem(LS_KEYS.SOS) || "[]"); }
    function setSOS(arr){ localStorage.setItem(LS_KEYS.SOS, JSON.stringify(arr)); }

    function nowISO(){ return new Date().toISOString(); }
    function fmtTime(iso){
      try{
        const d = new Date(iso);
        return d.toLocaleString();
      } catch { return iso; }
    }

    
    function computeStatus(shelter){
      const total = shelter.totalCapacity;
      const available = Math.max(0, total - shelter.occupied);

      const buffer = Math.max(5, Math.ceil(total * 0.2));

      if (!shelter.open) return { code: "RED", label: "Closed", available, buffer };

      if (available <= 0) return { code: "RED", label: "Full", available, buffer };

      if (available <= buffer) return { code: "YELLOW", label: "Limited", available, buffer };

      return { code: "GREEN", label: "Available", available, buffer };
    }

    function statusTagHTML(st){
      if (st.code === "GREEN") return `<span class="statusTag tagG"><span class="dot g"></span>${st.label}</span>`;
      if (st.code === "YELLOW") return `<span class="statusTag tagY"><span class="dot y"></span>${st.label}</span>`;
      return `<span class="statusTag tagR"><span class="dot r"></span>${st.label}</span>`;
    }

    
    function getSession(){
      return JSON.parse(localStorage.getItem(LS_KEYS.SESSION) || "null");
    }
    function setSession(sess){
      localStorage.setItem(LS_KEYS.SESSION, JSON.stringify(sess));
    }
    function logout(){
      localStorage.removeItem(LS_KEYS.SESSION);
      showScreen("login");
    }

    function handleLogin(){
      const role = document.getElementById("loginRole").value;
      const user = (document.getElementById("loginUser").value || "").trim();
      const pass = (document.getElementById("loginPass").value || "").trim();

      if (!user || !pass) { alert("Enter username and password"); return; }

      if (role === "admin"){
        if (user === "admin" && pass === "admin123"){
          setSession({ role:"admin", username:user });
          showScreen("admin");
        } else alert("Invalid admin credentials");
      }

      if (role === "manager"){
        const mgr = getManagers().find(m => m.username === user && m.password === pass);
        if (!mgr) { alert("Invalid manager credentials"); return; }
        setSession({ role:"manager", username:user, managerId:mgr.id });
        showScreen("manager");
      }

      if (role === "user"){
        if (pass !== "user123"){ alert("Invalid user password (demo: user123)"); return; }
        setSession({ role:"user", username:user });
        showScreen("user");
      }
    }

    
    function updateNetworkPill(){
      const pill = document.getElementById("netPill");
      const online = navigator.onLine;
      pill.textContent = online ? "Online: Live updates possible" : "Offline: Showing last-known data";
      pill.style.borderColor = online ? "rgba(46,204,113,0.35)" : "rgba(241,196,15,0.35)";
    }
    window.addEventListener("online", updateNetworkPill);
    window.addEventListener("offline", updateNetworkPill);

    
    let userMap, adminMap, managerMap;
    let userMarker = null;
    let selectedShelterId = null;

    function markerIconByStatus(code){
      
      const color = code === "GREEN" ? "#2ecc71" : (code === "YELLOW" ? "#f1c40f" : "#e74c3c");
      return color;
    }

    function initUserMap(){
      if (userMap) return;
      userMap = L.map("map").setView([13.0827, 80.2707], 12);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19, attribution: "¬© OpenStreetMap contributors"
      }).addTo(userMap);

      
      if (navigator.geolocation){
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            userMap.setView([lat, lng], 13);
            if (userMarker) userMap.removeLayer(userMarker);
            userMarker = L.marker([lat, lng]).addTo(userMap).bindPopup("üìç You are here").openPopup();
            renderUserSheltersOnMap();
          },
          () => {
            
            renderUserSheltersOnMap();
          },
          { enableHighAccuracy:true, timeout:6000 }
        );
      } else {
        renderUserSheltersOnMap();
      }
    }

    function renderUserSheltersOnMap(){
      if (!userMap) return;

      
      userMap.eachLayer(layer => {
        if (layer instanceof L.CircleMarker) userMap.removeLayer(layer);
      });

      const shelters = getShelters();

      shelters.forEach(s => {
        const st = computeStatus(s);
        const color = markerIconByStatus(st.code);

        const cm = L.circleMarker([s.lat, s.lng], {
          radius: 10,
          color: color,
          fillColor: color,
          fillOpacity: 0.8
        }).addTo(userMap);

        cm.on("click", () => {
          selectedShelterId = s.id;
          renderSelectedShelterDetails();
        });

        cm.bindPopup(`
          <b>${escapeHTML(s.name)}</b><br/>
          ${st.label} | Available: ${st.available}/${s.totalCapacity}<br/>
          Food: ${s.food} | Water: ${s.water} | Medical: ${s.medical}<br/>
          <small>Last updated: ${fmtTime(s.lastUpdated)}</small>
        `);
      });

      renderRecommendation();
    }

    function initAdminMap(){
      if (adminMap) return;
      adminMap = L.map("mapAdmin").setView([13.0827, 80.2707], 12);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19, attribution: "¬© OpenStreetMap contributors"
      }).addTo(adminMap);
      renderAdminMapMarkers();
    }

    function renderAdminMapMarkers(){
      if (!adminMap) return;
      adminMap.eachLayer(layer => {
        if (layer instanceof L.CircleMarker) adminMap.removeLayer(layer);
      });

      const shelters = getShelters();
      shelters.forEach(s => {
        const st = computeStatus(s);
        const color = markerIconByStatus(st.code);

        const cm = L.circleMarker([s.lat, s.lng], {
          radius: 10, color, fillColor: color, fillOpacity: 0.8
        }).addTo(adminMap);

        cm.bindPopup(`
          <b>${escapeHTML(s.name)}</b><br/>
          ${st.label} | Available: ${st.available}/${s.totalCapacity}<br/>
          Occupied: ${s.occupied}<br/>
          Food: ${s.food} | Water: ${s.water} | Medical: ${s.medical}<br/>
          <small>Last updated: ${fmtTime(s.lastUpdated)}</small>
        `);
      });
    }

    function initManagerMap(){
      if (managerMap) return;
      managerMap = L.map("mapManager").setView([13.0827, 80.2707], 12);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19, attribution: "¬© OpenStreetMap contributors"
      }).addTo(managerMap);
      renderManagerMap();
    }

    function renderManagerMap(){
      if (!managerMap) return;

      managerMap.eachLayer(layer => {
        if (layer instanceof L.CircleMarker || layer instanceof L.Marker) managerMap.removeLayer(layer);
      });

      const sess = getSession();
      const mgr = getManagers().find(m => m.id === sess?.managerId);
      const shelters = getShelters();
      const shelter = shelters.find(s => s.id === mgr?.shelterId);
      if (!shelter) return;

      const st = computeStatus(shelter);
      const color = markerIconByStatus(st.code);

      managerMap.setView([shelter.lat, shelter.lng], 14);

      const cm = L.circleMarker([shelter.lat, shelter.lng], {
        radius: 12, color, fillColor: color, fillOpacity: 0.85
      }).addTo(managerMap);

      cm.bindPopup(`
        <b>${escapeHTML(shelter.name)}</b><br/>
        ${st.label} | Available: ${st.available}/${shelter.totalCapacity}<br/>
        Occupied: ${shelter.occupied}<br/>
        <small>Last updated: ${fmtTime(shelter.lastUpdated)}</small>
      `).openPopup();
    }

    
    function facilityScore(s){
      let score = 0;
      // facility scoring
      if (s.food === "available") score += 1;
      if (s.water === "available") score += 1;
      if (s.medical === "available") score += 2;
      if (s.medical === "limited") score += 1;
      return score;
    }

    function distanceKm(aLat, aLng, bLat, bLng){

      const R = 6371;
      const dLat = (bLat - aLat) * Math.PI/180;
      const dLng = (bLng - aLng) * Math.PI/180;
      const sa = Math.sin(dLat/2)**2 +
        Math.cos(aLat*Math.PI/180)*Math.cos(bLat*Math.PI/180)*Math.sin(dLng/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(sa), Math.sqrt(1-sa));
      return R*c;
    }

    function getUserLatLng(){
      if (userMarker) {
        const ll = userMarker.getLatLng();
        return { lat: ll.lat, lng: ll.lng };
      }
      
      return { lat: 13.0827, lng: 80.2707 };
    }

    function renderRecommendation(){
      const box = document.getElementById("recommendedBox");
      const shelters = getShelters();
      const online = navigator.onLine;

      const userLL = getUserLatLng();

      
      const scored = shelters.map(s => {
        const st = computeStatus(s);
        const d = distanceKm(userLL.lat, userLL.lng, s.lat, s.lng);
        const fac = facilityScore(s);

        let eligible = (st.code === "GREEN");
        if (online) {
          eligible = (st.code === "GREEN" || st.code === "YELLOW"); 
        }


        const available = st.available;
        const score =
          (100 - Math.min(d*10, 100)) * 0.45 +     
          Math.min((available / s.totalCapacity) * 100, 100) * 0.35 +
          (fac * 10) * 0.20;                       

        return { s, st, d, fac, score, eligible };
      });

      const candidates = scored.filter(x => x.eligible && x.st.code !== "RED");
      const best = candidates.sort((a,b) => b.score - a.score)[0];

      if (!best){
        box.innerHTML = `
          <b>No safe recommendation right now</b><br/>
          <span class="muted">All shelters are full/closed or low-confidence (offline). Try contacting Admin or use SOS.</span>
        `;
        return;
      }

      box.innerHTML = `
        <div class="itemHead">
          <div>
            <b>${escapeHTML(best.s.name)}</b><br/>
            ${statusTagHTML(best.st)}
          </div>
          <div class="muted mono">
            ${best.d.toFixed(2)} km
          </div>
        </div>
        <div style="margin-top:8px" class="muted">
          Available: <b>${best.st.available}</b> / ${best.s.totalCapacity}<br/>
          Facilities: Food(${best.s.food}), Water(${best.s.water}), Medical(${best.s.medical})<br/>
          <small>Last updated: ${fmtTime(best.s.lastUpdated)}</small><br/>
          <small>${online ? "Online mode: best available option." : "Offline conservative mode: avoiding near-full shelters."}</small>
        </div>
      `;
    }

    
    function renderSelectedShelterDetails(){
      const box = document.getElementById("shelterDetails");
      if (!selectedShelterId){
        box.textContent = "Click a shelter marker to view details.";
        box.classList.add("muted");
        return;
      }
      const shelters = getShelters();
      const s = shelters.find(x => x.id === selectedShelterId);
      if (!s) return;
      const st = computeStatus(s);

      box.classList.remove("muted");
      box.innerHTML = `
        <div class="itemHead">
          <div>
            <b>${escapeHTML(s.name)}</b><br/>
            ${statusTagHTML(st)}
          </div>
          <div class="muted mono">ID: ${s.id}</div>
        </div>
        <div style="margin-top:8px">
          <div>Available: <b>${st.available}</b> / ${s.totalCapacity}</div>
          <div>Occupied: <b>${s.occupied}</b></div>
          <div>Food: <b>${s.food}</b> | Water: <b>${s.water}</b> | Medical: <b>${s.medical}</b></div>
          <div class="muted"><small>Last updated: ${fmtTime(s.lastUpdated)}</small></div>
          <div class="muted"><small>${navigator.onLine ? "" : "Offline: availability may have changed."}</small></div>
        </div>
      `;
    }


    function openMessageModal(){ document.getElementById("modalMsg").classList.remove("hidden"); }
    function closeMessageModal(){ document.getElementById("modalMsg").classList.add("hidden"); document.getElementById("msgText").value=""; }

    function sendMessageToAdmin(){
      const sess = getSession();
      const text = (document.getElementById("msgText").value || "").trim();
      if (!text) { alert("Enter a message"); return; }

      const msg = {
        id: "MSG_" + Math.random().toString(16).slice(2),
        fromUser: sess.username,
        text,
        shelterId: selectedShelterId || null,
        time: nowISO(),
        replyText: null,
        replyTime: null
      };
      const all = getMessages();
      all.unshift(msg);
      setMessages(all);

      closeMessageModal();
      renderAll();
      alert("Message sent to Admin ‚úÖ");
    }

    function renderUserThread(){
      const sess = getSession();
      const box = document.getElementById("userMsgThread");
      const all = getMessages().filter(m => m.fromUser === sess.username);

      if (all.length === 0){
        box.innerHTML = `<div class="muted">No messages yet.</div>`;
        return;
      }

      box.innerHTML = all.map(m => `
        <div class="item">
          <div class="muted"><small>${fmtTime(m.time)}</small></div>
          <div><b>You:</b> ${escapeHTML(m.text)}</div>
          ${m.replyText ? `<div class="reply"><b>Admin:</b> ${escapeHTML(m.replyText)}<br/><span class="muted"><small>${fmtTime(m.replyTime)}</small></span></div>` : `<div class="muted"><small>Waiting for admin reply‚Ä¶</small></div>`}
        </div>
      `).join("");
    }

    function openSOSModal(){ document.getElementById("modalSOS").classList.remove("hidden"); }
    function closeSOSModal(){ document.getElementById("modalSOS").classList.add("hidden"); document.getElementById("sosMsg").value=""; }

    function sendSOS(){
      const sess = getSession();
      const reason = document.getElementById("sosReason").value;
      const message = (document.getElementById("sosMsg").value || "").trim();

      const userLL = getUserLatLng();

      const ticket = {
        id: "SOS_" + Math.random().toString(16).slice(2),
        fromUser: sess.username,
        reason,
        message,
        lat: userLL.lat,
        lng: userLL.lng,
        status: "Sent",
        time: nowISO(),
        adminResponse: null,
        adminResponseTime: null
      };

      const all = getSOS();
      all.unshift(ticket);
      setSOS(all);

      closeSOSModal();
      renderAll();
      alert("SOS sent to Admin ‚úÖ");
    }

    /***********************
     * ADMIN: RENDER + ACTIONS
     ***********************/
    function renderAdminManagers(){
      const box = document.getElementById("adminManagersList");
      const managers = getManagers();
      const shelters = getShelters();
      box.innerHTML = managers.map(m => {
        const sh = shelters.find(s => s.id === m.shelterId);
        return `
          <div class="item">
            <div class="itemHead">
              <div><b>${escapeHTML(m.name)}</b><div class="muted mono">${escapeHTML(m.username)}</div></div>
              <div class="muted">${escapeHTML(m.phone)}</div>
            </div>
            <div class="muted" style="margin-top:6px">
              Assigned Shelter: <b>${sh ? escapeHTML(sh.name) : "‚Äî"}</b>
            </div>
          </div>
        `;
      }).join("");
    }

    function renderAdminShelters(){
      const box = document.getElementById("adminSheltersList");
      const shelters = getShelters();

      document.getElementById("adminTotalShelters").textContent = shelters.length;

      box.innerHTML = shelters.map(s => {
        const st = computeStatus(s);
        return `
          <div class="item">
            <div class="itemHead">
              <div>
                <b>${escapeHTML(s.name)}</b><br/>
                ${statusTagHTML(st)} <span class="muted"><small>(Avail: ${st.available}/${s.totalCapacity}, buffer: ${st.buffer})</small></span>
              </div>
              <div class="muted"><small>Updated: ${fmtTime(s.lastUpdated)}</small></div>
            </div>

            <div class="grid three" style="margin-top:10px">
              <div>
                <label>Occupied</label>
                <input type="number" min="0" value="${s.occupied}" id="occ_${s.id}">
              </div>
              <div>
                <label>Open?</label>
                <select id="open_${s.id}">
                  <option value="true" ${s.open ? "selected" : ""}>Open</option>
                  <option value="false" ${!s.open ? "selected" : ""}>Closed</option>
                </select>
              </div>
              <div>
                <label>Total Capacity</label>
                <input type="number" min="1" value="${s.totalCapacity}" id="tot_${s.id}">
              </div>
            </div>

            <div class="grid three" style="margin-top:10px">
              <div>
                <label>Food</label>
                <select id="food_${s.id}">
                  ${opt(s.food, ["available","low","out"])}
                </select>
              </div>
              <div>
                <label>Water</label>
                <select id="water_${s.id}">
                  ${opt(s.water, ["available","low","out"])}
                </select>
              </div>
              <div>
                <label>Medical</label>
                <select id="medical_${s.id}">
                  ${opt(s.medical, ["available","limited","none"])}
                </select>
              </div>
            </div>

            <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap">
              <button class="btn primary small" onclick="adminSaveShelter('${s.id}')">Save Changes</button>
              <button class="btn small" onclick="adminZoomShelter('${s.id}')">Zoom on Map</button>
            </div>
          </div>
        `;
      }).join("");
    }

    function opt(current, arr){
      return arr.map(v => `<option value="${v}" ${v===current?"selected":""}>${v}</option>`).join("");
    }

    function adminSaveShelter(id){
      const shelters = getShelters();
      const s = shelters.find(x => x.id === id);
      if (!s) return;

      const occ = Number(document.getElementById("occ_"+id).value);
      const tot = Number(document.getElementById("tot_"+id).value);
      const open = document.getElementById("open_"+id).value === "true";
      const food = document.getElementById("food_"+id).value;
      const water = document.getElementById("water_"+id).value;
      const medical = document.getElementById("medical_"+id).value;

      if (!Number.isFinite(occ) || occ < 0) { alert("Occupied must be >= 0"); return; }
      if (!Number.isFinite(tot) || tot <= 0) { alert("Total capacity must be > 0"); return; }
      if (occ > tot) { alert("Occupied cannot exceed total capacity"); return; }

      s.occupied = occ;
      s.totalCapacity = tot;
      s.open = open;
      s.food = food;
      s.water = water;
      s.medical = medical;
      s.lastUpdated = nowISO();

      setShelters(shelters);
      renderAll();
      alert("Shelter updated ‚úÖ");
    }

    function adminZoomShelter(id){
      const s = getShelters().find(x => x.id === id);
      if (!s || !adminMap) return;
      adminMap.setView([s.lat, s.lng], 15);
    }

    function renderAdminMessages(){
      const box = document.getElementById("adminMessagesList");
      const shelters = getShelters();
      const all = getMessages();

      if (all.length === 0){
        box.innerHTML = `<div class="muted">No messages yet.</div>`;
        return;
      }

      box.innerHTML = all.map(m => {
        const sh = m.shelterId ? shelters.find(s => s.id === m.shelterId) : null;
        return `
          <div class="item">
            <div class="itemHead">
              <div>
                <b>${escapeHTML(m.fromUser)}</b>
                <div class="muted"><small>${fmtTime(m.time)}</small></div>
              </div>
              <div class="muted">${sh ? "Shelter: " + escapeHTML(sh.name) : ""}</div>
            </div>
            <div style="margin-top:6px">${escapeHTML(m.text)}</div>

            ${m.replyText ? `
              <div class="reply">
                <b>Replied:</b> ${escapeHTML(m.replyText)}<br/>
                <span class="muted"><small>${fmtTime(m.replyTime)}</small></span>
              </div>
            ` : `
              <label style="margin-top:10px">Reply</label>
              <textarea id="reply_${m.id}" placeholder="Type reply to user..."></textarea>
              <div style="display:flex; justify-content:flex-end; margin-top:8px">
                <button class="btn primary small" onclick="adminReply('${m.id}')">Send Reply</button>
              </div>
            `}
          </div>
        `;
      }).join("");
    }

    function adminReply(msgId){
      const all = getMessages();
      const msg = all.find(x => x.id === msgId);
      if (!msg) return;

      const text = (document.getElementById("reply_"+msgId).value || "").trim();
      if (!text) { alert("Enter reply"); return; }

      msg.replyText = text;
      msg.replyTime = nowISO();
      setMessages(all);
      renderAll();
      alert("Reply sent ‚úÖ");
    }

    function renderAdminSOS(){
      const box = document.getElementById("adminSOSList");
      const all = getSOS();

      const openCount = all.filter(x => x.status !== "Resolved").length;
      document.getElementById("adminOpenSOS").textContent = openCount;

      if (all.length === 0){
        box.innerHTML = `<div class="muted">No SOS alerts yet.</div>`;
        return;
      }

      box.innerHTML = all.map(t => `
        <div class="item">
          <div class="itemHead">
            <div>
              <b>${escapeHTML(t.fromUser)}</b> ‚Äì <span class="muted">${escapeHTML(t.reason)}</span>
              <div class="muted"><small>${fmtTime(t.time)}</small></div>
            </div>
            <div class="statusTag ${t.status==="Resolved"?"tagG":(t.status==="Acknowledged"?"tagY":"tagR")}">
              ${t.status}
            </div>
          </div>

          <div style="margin-top:6px">
            <div class="muted"><small>Location:</small> <span class="mono">${t.lat.toFixed(5)}, ${t.lng.toFixed(5)}</span></div>
            <div style="margin-top:6px">${escapeHTML(t.message || "(no message)")}</div>
          </div>

          ${t.adminResponse ? `
            <div class="reply">
              <b>Admin response:</b> ${escapeHTML(t.adminResponse)}<br/>
              <span class="muted"><small>${fmtTime(t.adminResponseTime)}</small></span>
            </div>
          ` : `
            <label style="margin-top:10px">Respond</label>
            <textarea id="sosreply_${t.id}" placeholder="Example: Stay calm. Nearest shelter is Egmore School. Rescue team informed."></textarea>
            <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:8px; flex-wrap:wrap">
              <button class="btn small" onclick="adminAcknowledgeSOS('${t.id}')">Acknowledge</button>
              <button class="btn primary small" onclick="adminRespondSOS('${t.id}')">Send Response</button>
              <button class="btn good small" onclick="adminResolveSOS('${t.id}')">Mark Resolved</button>
            </div>
          `}
        </div>
      `).join("");
    }

    function adminAcknowledgeSOS(id){
      const all = getSOS();
      const t = all.find(x => x.id === id);
      if (!t) return;
      if (t.status === "Resolved") return;
      t.status = "Acknowledged";
      setSOS(all);
      renderAll();
    }

    function adminRespondSOS(id){
      const all = getSOS();
      const t = all.find(x => x.id === id);
      if (!t) return;
      const text = (document.getElementById("sosreply_"+id).value || "").trim();
      if (!text) { alert("Enter SOS response"); return; }
      t.adminResponse = text;
      t.adminResponseTime = nowISO();
      if (t.status !== "Resolved") t.status = "Acknowledged";
      setSOS(all);
      renderAll();
      alert("SOS response sent ‚úÖ");
    }

    function adminResolveSOS(id){
      const all = getSOS();
      const t = all.find(x => x.id === id);
      if (!t) return;
      t.status = "Resolved";
      setSOS(all);
      renderAll();
    }

    /***********************
     * MANAGER: UPDATE
     ***********************/
    function renderManagerScreen(){
      const sess = getSession();
      const mgr = getManagers().find(m => m.id === sess?.managerId);
      const shelters = getShelters();
      const sh = shelters.find(s => s.id === mgr?.shelterId);

      if (!mgr || !sh){
        document.getElementById("mgrShelterName").textContent = "No assigned shelter";
        return;
      }

      const st = computeStatus(sh);
      document.getElementById("mgrShelterName").textContent = sh.name;
      document.getElementById("mgrShelterMeta").innerHTML =
        `${statusTagHTML(st)} <span class="muted">Avail: ${st.available}/${sh.totalCapacity} | Updated: ${fmtTime(sh.lastUpdated)}</span>`;

      document.getElementById("mgrOccupied").value = sh.occupied;
      document.getElementById("mgrOpen").value = String(sh.open);
      document.getElementById("mgrFood").value = sh.food;
      document.getElementById("mgrWater").value = sh.water;
      document.getElementById("mgrMedical").value = sh.medical;

      initManagerMap();
      renderManagerMap();
    }

    function managerSubmitUpdate(){
      const sess = getSession();
      const mgr = getManagers().find(m => m.id === sess?.managerId);
      if (!mgr) return;

      const shelters = getShelters();
      const sh = shelters.find(s => s.id === mgr.shelterId);
      if (!sh) return;

      const occ = Number(document.getElementById("mgrOccupied").value);
      const open = document.getElementById("mgrOpen").value === "true";
      const food = document.getElementById("mgrFood").value;
      const water = document.getElementById("mgrWater").value;
      const medical = document.getElementById("mgrMedical").value;

      if (!Number.isFinite(occ) || occ < 0) { alert("Occupied must be >= 0"); return; }
      if (occ > sh.totalCapacity) { alert("Occupied cannot exceed total capacity"); return; }

      sh.occupied = occ;
      sh.open = open;
      sh.food = food;
      sh.water = water;
      sh.medical = medical;
      sh.lastUpdated = nowISO();

      setShelters(shelters);
      renderAll();
      alert("Update sent to Admin ‚úÖ");
    }


    function showScreen(which){
      const topbar = document.getElementById("topbar");
      const login = document.getElementById("screenLogin");
      const admin = document.getElementById("screenAdmin");
      const manager = document.getElementById("screenManager");
      const user = document.getElementById("screenUser");

      login.classList.add("hidden");
      admin.classList.add("hidden");
      manager.classList.add("hidden");
      user.classList.add("hidden");

      if (which === "login"){
        topbar.classList.add("hidden");
        login.classList.remove("hidden");
        return;
      }

      topbar.classList.remove("hidden");
      updateNetworkPill();

      const sess = getSession();
      document.getElementById("whoamiPill").textContent = `${sess.role.toUpperCase()} ¬∑ ${sess.username}`;

      if (which === "admin"){
        admin.classList.remove("hidden");
        initAdminMap();
        renderAll();
      }
      if (which === "manager"){
        manager.classList.remove("hidden");
        renderManagerScreen();
      }
      if (which === "user"){
        user.classList.remove("hidden");
        initUserMap();
        renderAll();
      }
    }

    
    function renderAll(){
      const sess = getSession();
      if (!sess){ return; }

      if (sess.role === "admin"){
        renderAdminManagers();
        renderAdminShelters();
        renderAdminMessages();
        renderAdminSOS();
        renderAdminMapMarkers();
      }

      if (sess.role === "manager"){
        renderManagerScreen();
      }

      if (sess.role === "user"){
        renderUserSheltersOnMap();
        renderSelectedShelterDetails();
        renderUserThread();
      }
    }

    
    function escapeHTML(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    
    loadOrInit();

    const sess = getSession();
    if (!sess){
      showScreen("login");
    } else {
      showScreen(sess.role);
    }
  </script>
</body>
</html>